<!DOCTYPE html>
<html lang="en">
	<head>
		<title>OpenGarage Firmware Update</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<style>
			:root {
				--bg: #f6f7fb;
				--fg: #0f172a;
				--muted: #586380;
				--card: #fff;
				--border: #e2e8f0;
				--accent: #2563eb;
			}
			@media (prefers-color-scheme: dark) {
				:root {
					--bg: #0b1220;
					--fg: #e6eaff;
					--muted: #a3acc7;
					--card: #0f172a;
					--border: #1e293b;
					--accent: #60a5fa;
				}
			}
			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
					Helvetica, Arial, sans-serif;
				background-color: var(--bg);
				margin: 0;
				padding: 20px;
				color: var(--fg);
			}
			main {
				max-width: 600px;
				margin: 0 auto;
				background-color: var(--card);
				padding: 25px 30px;
				border-radius: 8px;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
			}
			h1 {
				text-align: center;
				color: var(--fg);
				margin-top: 0;
				margin-bottom: 25px;
			}
			.form-group {
				margin-bottom: 18px;
			}
			label {
				display: block;
				font-weight: 600;
				margin-bottom: 6px;
			}
			input[type="password"],
			input[type="file"] {
				width: 100%;
				padding: 10px;
				font-size: 16px;
				border: 1px solid var(--border);
				border-radius: 5px;
				box-sizing: border-box;
				background-color: transparent;
				color: inherit;
			}
			/* Style file input button */
			input[type="file"]::file-selector-button {
				font-weight: 600;
				color: var(--accent);
				background-color: transparent;
				border: 1px solid var(--accent);
				border-radius: 5px;
				padding: 8px 12px;
				cursor: pointer;
				margin-right: 10px;
			}
			button {
				width: 100%;
				padding: 12px;
				font-size: 16px;
				font-weight: 600;
				color: #fff;
				background-color: var(--accent);
				border: none;
				border-radius: 5px;
				cursor: pointer;
			}
			#msg {
				text-align: left;
				font-weight: 600;
				margin-bottom: 20px;
				min-height: 20px;
			}
		</style>
	</head>
	<body>
		<main>
			<h1>Firmware Update</h1>
			<form
				method="POST"
				action="/update"
				id="fm"
				enctype="multipart/form-data"
			>
				<div class="form-group">
					<label for="file">Firmware File (.bin)</label>
					<input type="file" name="file" accept=".bin" id="file" />
				</div>
				<div class="form-group">
					<label for="dkey">Device Key</label>
					<input type="password" name="dkey" id="dkey" />
				</div>

				<p id="msg"></p>
				<button type="button" id="btn_submit">Upload Firmware</button>
			</form>
		</main>

		<script>
			function id(s) {
				return document.getElementById(s);
			}
			function show_msg(s, c) {
				const msgEl = id("msg");
				msgEl.innerHTML = `<font color=${c}>${s}</font>`;
			}

			id("btn_submit").addEventListener("click", function (e) {
				e.preventDefault();
				const files = id("file").files;
				if (files.length === 0) {
					show_msg("Please select a firmware file.", "red");
					return;
				}
				if (id("dkey").value === "") {
					if (!confirm("You did not input a device key. Are you sure?")) return;
				}

				show_msg("Uploading... Please wait.", "gray");

				const fd = new FormData();
				const file = files[0];
				fd.append("file", file, file.name);
				fd.append("dkey", id("dkey").value);

				const xhr = new XMLHttpRequest();
				xhr.onreadystatechange = function () {
					if (xhr.readyState === 4 && xhr.status === 200) {
						const jd = JSON.parse(xhr.responseText);
						if (jd.result === 1) {
							show_msg(
								"Update successful! The device is rebooting. You may close this page now.",
								"green"
							);
						} else if (jd.result === 2) {
							show_msg(
								"Authentication failed. Check device key and try again.",
								"red"
							);
						} else {
							show_msg("Update failed. Please try again.", "red");
						}
					} else if (xhr.readyState === 4) {
						show_msg(
							"Upload failed. Could not connect to the update server.",
							"red"
						);
					}
				};
				xhr.upload.onprogress = function (evt) {
					if (evt.lengthComputable) {
						const pct = Math.max(
							5,
							Math.min(100, Math.round((evt.loaded / evt.total) * 100))
						);
						show_msg("Uploading...(" + pct + "%) Please wait.", "gray");
					}
				};
				// The submission URL correctly targets port 8080 as required
				const uploadUrl = "//" + window.location.hostname + ":8080/update";
				xhr.open("POST", uploadUrl, true);
				xhr.timeout = 300000; // 300s
				xhr.ontimeout = function () {
					show_msg("Upload timed out. Please try again.", "red");
				};
				xhr.onerror = function () {
					show_msg("Network error during upload.", "red");
				};
				xhr.send(fd);
			});
		</script>
	</body>
</html>
